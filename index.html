<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#1f2a44" />
  <title>FX Offline - EUR USD KHR</title>

  <link rel="manifest" href="manifest.json" />
  <style>
    :root { --bg:#0b1020; --card:#121a33; --text:#e9ecf7; --muted:#aab3d6; --border:#26305a; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background: linear-gradient(180deg,#0b1020,#070a14); color:var(--text); }
    header { padding:18px 16px 8px; }
    h1 { margin:0; font-size:18px; font-weight:750; letter-spacing:.2px; }
    .wrap { padding: 12px 16px 28px; display: grid; gap: 12px; max-width: 560px; margin: 0 auto; }
    .card { background: rgba(18,26,51,.92); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row { display:flex; gap:10px; align-items:center; }
    .grid3 { display:grid; grid-template-columns: 1fr; gap: 10px; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input {
      width: 100%; padding: 14px 12px; border-radius: 12px;
      border: 1px solid var(--border); background: #0e1530; color: var(--text);
      outline: none; font-size: 18px; font-weight: 750;
    }
    .sub { color: var(--muted); font-size: 12px; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius: 999px; border: 1px solid var(--border); background:#0e1530; font-size: 12px; color: var(--muted); }
    .hr { height:1px; background: rgba(38,48,90,.7); margin: 10px 0; }
    .btn {
      padding: 12px 12px; border-radius: 12px; border: 1px solid var(--border);
      background: #0e1530; color: var(--text); font-weight: 650; cursor: pointer;
    }
    .btn.primary { background:#1f2a44; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; background: #0e1530; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 12px; display:none; max-width: 90vw;}
  </style>
</head>

<body>
  <header>
    <div class="wrap" style="padding:0 16px;">
      <h1>FX Offline ‚Äî EUR / USD / KHR</h1>
      <div class="row" style="gap:8px; padding-bottom:8px;">
        <span id="netPill" class="pill">‚ö° Hors-ligne</span>
        <span id="lastPill" class="pill">‚è± ‚Äî</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- 3 inputs synced -->
    <section class="card">
      <div style="font-weight:750;">Convertisseur (3 cases)</div>
      <div class="sub">Tape dans n‚Äôimporte quelle devise : les 2 autres se recalculent.</div>
      <div class="hr"></div>

      <div class="grid3">
        <div>
          <label>EUR (‚Ç¨)</label>
          <input id="eur" inputmode="decimal" placeholder="0" />
        </div>
        <div>
          <label>USD ($)</label>
          <input id="usd" inputmode="decimal" placeholder="0" />
        </div>
        <div>
          <label>KHR (·üõ)</label>
          <input id="khr" inputmode="decimal" placeholder="0" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="clearBtn" class="btn">üßπ Effacer</button>
      </div>
    </section>

    <!-- Rates -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:750;">Taux (base USD)</div>
          <div class="sub">Sauvegard√©s sur ton t√©l√©phone ‚Ä¢ offline OK</div>
        </div>
        <button id="resetBtn" class="btn">Reset</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:10px;">
        <div style="flex:1;">
          <label>1 USD = ? EUR</label>
          <input id="usdToEur" inputmode="decimal" />
        </div>
        <div style="flex:1;">
          <label>1 USD = ? KHR</label>
          <input id="usdToKhr" inputmode="decimal" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="saveBtn" class="btn primary" style="flex:1;">üíæ Enregistrer</button>
        <button id="updateBtn" class="btn" style="flex:1;">üîÑ Mettre √† jour (si internet)</button>
      </div>

      <div class="sub" style="margin-top:10px;">
        Astuce Cambodge : colle au taux du changeur (ex. 1 USD = 4050 KHR).
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

<script>
  // ---------- Offline-first data ----------
  const STORAGE_KEY = "fx_rates_v3";
  const DEFAULT_RATES = {
    usdToEur: 0.92,
    usdToKhr: 4100,
    updatedAt: new Date().toISOString(),
    source: "Seed (embedded)"
  };

  function loadRates() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { ...DEFAULT_RATES };
      const obj = JSON.parse(raw);
      if (!obj.usdToEur || !obj.usdToKhr) return { ...DEFAULT_RATES };
      return obj;
    } catch {
      return { ...DEFAULT_RATES };
    }
  }

  function saveRates(r) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(r));
  }

  // ---------- Converter (base USD) ----------
  function convert(amount, from, to, rates) {
    if (from === to) return amount;

    const usd = (from === "USD") ? amount
              : (from === "EUR") ? amount / rates.usdToEur
              : amount / rates.usdToKhr;

    const out = (to === "USD") ? usd
              : (to === "EUR") ? usd * rates.usdToEur
              : usd * rates.usdToKhr;

    return out;
  }

  function parseNum(s) {
    const raw = (s || "")
      .replace(/\s/g, "")   // remove thousands separators
      .replace(",", ".")
      .trim();
    const n = parseFloat(raw);
    return isFinite(n) ? n : 0;
  }

  function formatWithThousands(value, ccy) {
    if (!isFinite(value)) return "";
    if (ccy === "KHR") {
      return Math.round(value)
        .toString()
        .replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    return value
      .toFixed(2)
      .replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  // ---------- UI ----------
  const el = (id) => document.getElementById(id);
  const eurEl = el("eur");
  const usdEl = el("usd");
  const khrEl = el("khr");
  const usdToEurEl = el("usdToEur");
  const usdToKhrEl = el("usdToKhr");
  const lastPill = el("lastPill");
  const netPill = el("netPill");
  const toast = el("toast");

  let rates = loadRates();

  function toastMsg(msg) {
    toast.textContent = msg;
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 2200);
  }

  function setPills() {
    const dt = new Date(rates.updatedAt);
    const pad = (n) => String(n).padStart(2,'0');
    const label = `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    lastPill.textContent = `‚è± ${label} ‚Ä¢ ${rates.source}`;
    netPill.textContent = navigator.onLine ? "üåê En ligne" : "‚ö° Hors-ligne";
  }

  function syncRatesInputs() {
    usdToEurEl.value = String(rates.usdToEur);
    usdToKhrEl.value = String(rates.usdToKhr);
  }

  // Prevent infinite loops: only update others when user edits one field
  let activeField = null;

  function updateFrom(fromCcy) {
    const a = (fromCcy === "EUR") ? parseNum(eurEl.value)
            : (fromCcy === "USD") ? parseNum(usdEl.value)
            : parseNum(khrEl.value);

    const eur = convert(a, fromCcy, "EUR", rates);
    const usd = convert(a, fromCcy, "USD", rates);
    const khr = convert(a, fromCcy, "KHR", rates);

    if (activeField !== "EUR") eurEl.value = formatWithThousands(eur, "EUR");
    if (activeField !== "USD") usdEl.value = formatWithThousands(usd, "USD");
    if (activeField !== "KHR") khrEl.value = formatWithThousands(khr, "KHR");

    setPills();
  }

  // Focus determines which field should NOT be auto-formatted while typing
  eurEl.addEventListener("focus", () => activeField = "EUR");
  usdEl.addEventListener("focus", () => activeField = "USD");
  khrEl.addEventListener("focus", () => activeField = "KHR");

  eurEl.addEventListener("input", () => updateFrom("EUR"));
  usdEl.addEventListener("input", () => updateFrom("USD"));
  khrEl.addEventListener("input", () => updateFrom("KHR"));

  // Clear button
  el("clearBtn").addEventListener("click", () => {
    eurEl.value = "";
    usdEl.value = "";
    khrEl.value = "";
    toastMsg("Effac√©");
  });

  // Rates save/reset/update
  el("saveBtn").addEventListener("click", () => {
    const eur = parseNum(usdToEurEl.value);
    const khr = parseNum(usdToKhrEl.value);
    if (!isFinite(eur) || eur <= 0 || !isFinite(khr) || khr <= 0) {
      toastMsg("Taux invalides.");
      return;
    }
    rates = {
      usdToEur: eur,
      usdToKhr: khr,
      updatedAt: new Date().toISOString(),
      source: "Manual"
    };
    saveRates(rates);
    setPills();

    if (eurEl.value) updateFrom("EUR");
    else if (usdEl.value) updateFrom("USD");
    else if (khrEl.value) updateFrom("KHR");

    toastMsg("Taux enregistr√©s ‚úÖ");
  });

  el("resetBtn").addEventListener("click", () => {
    rates = { ...DEFAULT_RATES, updatedAt: new Date().toISOString(), source: "Seed (embedded)" };
    saveRates(rates);
    syncRatesInputs();
    setPills();

    if (eurEl.value) updateFrom("EUR");
    else if (usdEl.value) updateFrom("USD");
    else if (khrEl.value) updateFrom("KHR");

    toastMsg("Reset OK");
  });

  el("updateBtn").addEventListener("click", async () => {
    if (!navigator.onLine) {
      toastMsg("Pas de connexion ‚Äî offline OK.");
      return;
    }
    el("updateBtn").disabled = true;
    el("updateBtn").textContent = "‚è≥ Mise √† jour...";
    try {
      const res = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=EUR,KHR", { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!data?.rates?.EUR || !data?.rates?.KHR) throw new Error("Missing EUR/KHR");
      rates = {
        usdToEur: Number(data.rates.EUR),
        usdToKhr: Number(data.rates.KHR),
        updatedAt: new Date().toISOString(),
        source: "exchangerate.host"
      };
      saveRates(rates);
      syncRatesInputs();
      setPills();

      if (eurEl.value) updateFrom("EUR");
      else if (usdEl.value) updateFrom("USD");
      else if (khrEl.value) updateFrom("KHR");

      toastMsg("Taux mis √† jour ‚úÖ");
    } catch (e) {
      toastMsg("MAJ impossible. On garde les taux offline.");
    } finally {
      el("updateBtn").disabled = false;
      el("updateBtn").textContent = "üîÑ Mettre √† jour (si internet)";
    }
  });

  window.addEventListener("online", setPills);
  window.addEventListener("offline", setPills);

  // Init
  syncRatesInputs();
  setPills();

  // Service worker registration
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>
</body>
</html>
